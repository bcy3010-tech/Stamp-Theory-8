<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨‚ç†èª²é›†é»å¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .stamp-circle {
            width: 45px;
            height: 45px;
            border: 3px dashed #d1d5db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ffffff, #f9fafb);
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .stamp-circle:hover {
            border-color: #f59e0b;
            border-style: solid;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }
        
        .stamp-circle.stamped {
            border: 3px solid #10b981;
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            animation: bounce 0.5s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .piano-key {
            display: inline-block;
            margin: 0 1px;
        }
        
        .white-key {
            width: 20px;
            height: 60px;
            background: white;
            border: 2px solid #374151;
            border-radius: 0 0 8px 8px;
        }
        
        .black-key {
            width: 12px;
            height: 35px;
            background: #374151;
            border-radius: 0 0 4px 4px;
            margin: 0 -7px;
            z-index: 2;
            position: relative;
        }
        
        .reward-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f59e0b;
            animation: confetti-fall 3s linear infinite;
            z-index: 1000;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        
        .reward-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .reward-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            animation: slideIn 0.5s ease;
            border: 4px solid #fbbf24;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.8); }
            to { transform: translateY(0) scale(1); }
        }
        
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            animation: fadeIn 0.3s ease;
        }
        
        .export-card {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            animation: slideIn 0.5s ease;
            border: 4px solid #3b82f6;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .student-switch-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.7) !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 9999 !important;
            animation: fadeIn 0.3s ease !important;
        }

        .student-switch-card {
            background: white !important;
            padding: 2rem !important;
            border-radius: 20px !important;
            text-align: center !important;
            max-width: 400px !important;
            margin: 0 1rem !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
            border: 4px solid #10b981 !important;
            animation: slideIn 0.5s ease !important;
        }
    </style>
</head>
<body style="background-color: #cfeeff;" class="min-h-screen">
    <!-- Association Name -->
    <div class="absolute top-4 left-4 text-gray-600 text-sm font-medium flex items-center">
        <img src="https://export-download.canva.com/connect2music" alt="å”æœƒLogo" class="w-8 h-8 mr-2 rounded-full" onerror="this.style.display='none';">
        è‡ºç£åé„‰éŸ³æ¨‚æ¨å»£å”æœƒ
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">æ­£åœ¨åˆ‡æ›å­¸ç”Ÿè³‡æ–™...</p>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex justify-center items-center mb-4">
                <img src="connect2music.JPG" alt="å…”å­" class="w-24 h-24 rounded-full shadow-lg" onerror="this.style.display='none';">
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ» æ¨‚ç†èª²é›†é»å¡</h1>
            <p class="text-gray-600">èªçœŸä¸Šèª²ã€é–‹å¿ƒè½éŸ³æ¨‚ï¼</p>
        </div>
<!-- Student Info Card -->
<div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-2xl font-semibold text-gray-800">å­¸ç”Ÿå§“åï¼šç‹æ™Ÿå‡±</h2>
      <div class="mt-2">
        <div class="flex justify-between items-end">
          <div class="flex space-x-24 items-end">
          </div>

          <!-- åŠ  flex justify-end -->
          <div class="flex justify-end">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">ä¸Šå­¸æœŸå‰©é¤˜é»æ•¸</label>
             <div class="flex items-center space-x-2">
  <input type="number" id="previousPoints"
         class="border border-gray-300 rounded-lg px-3 py-2 w-20 text-center"
         value="0" min="0" readonly>
  <button onclick="showPasswordModal()"
          class="bg-slate-300 hover:bg-slate-400 text-white px-2 py-2 rounded-lg text-sm font-semibold transition-colors">
    ç·¨è¼¯
  </button>
  <button onclick="uploadCurrentData()"
          class="bg-blue-300 hover:bg-blue-400 text-white px-2 py-2 rounded-lg text-sm font-semibold transition-colors">
    ä¸Šå‚³
  </button>
</div>
            </div>
          </div>
          <!-- åˆ°é€™è£¡ -->
        </div>
      </div>
    </div>
  </div>
</div>


        <!-- Rules Section -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">é›†é»è¦å‰‡</h2>
            
            <div class="space-y-6">
                <!-- æ¯å ‚èª²æœ€å¤š -->
                <div style="background-color: #fdf2f8;" class="rounded-lg p-4">
                    <div class="flex items-center justify-center">
                        <h3 class="text-lg font-semibold text-black">â­ é‡è¦æé†’ï¼šæ¯å ‚èª²æœ€å¤šç´¯ç© 4 é»ç« æ•¸</h3>
                    </div>
                </div>
                
                <!-- æº–æ™‚ä¸Šèª² -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">â° æº–æ™‚ä¸Šèª²</h3>
                            <p class="text-gray-600">æº–æ™‚é€²å…¥ä¸Šèª²é€£çµï¼š1å€‹ç« </p>
                        </div>
                        <button onclick="addStampsByRule(1)" class="bg-gradient-to-r from-sky-300 to-blue-300 hover:from-sky-400 hover:to-blue-400 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                            å°ç« 
                        </button>
                    </div>
                </div>
                
                <!-- ä¸Šèª²æ…‹åº¦ -->
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">ğŸ’ª ä¸Šèª²æ…‹åº¦</h3>
                            <p class="text-gray-600">ä¸Šèª²æ…‹åº¦ç©æ¥µã€åŠªåŠ›ã€åƒèˆ‡åº¦é«˜ï¼š1å€‹ç« </p>
                        </div>
                        <button onclick="addStampsByRule(1)" class="bg-gradient-to-r from-emerald-300 to-green-300 hover:from-emerald-400 hover:to-green-400 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                            å°ç« 
                        </button>
                    </div>
                </div>
                
                <!-- ä½œæ¥­ç‹€æ³ -->
                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-4 border border-yellow-100">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ¼ ä½œæ¥­ç‹€æ³</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between bg-white/50 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-gray-600 rounded-full mr-3"></span>
                                <span class="text-gray-600">å®Œæˆè©²é€±æ‰€æœ‰ä½œæ¥­ï¼š1å€‹ç« </span>
                            </div>
                            <button onclick="addStampsByRule(1)" class="bg-gradient-to-r from-teal-300 to-cyan-300 hover:from-teal-400 hover:to-cyan-400 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105">
                                +1 å°ç« 
                            </button>
                        </div>
                        <div class="space-y-3">
                        <div class="flex items-center justify-between bg-white/50 rounded-lg p-3">
                            <div class="flex items-center">
                                <span class="w-3 h-3 bg-gray-600 rounded-full mr-3"></span>
                                <span class="text-gray-600">è©²é€±ä½œæ¥­ç”¨å¿ƒå®Œæˆã€ç­”å°ç‡é«˜ï¼š1å€‹ç« </span>
                            </div>
                            <button onclick="addStampsByRule(1)" class="bg-gradient-to-r from-teal-300 to-cyan-300 hover:from-teal-400 hover:to-cyan-400 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all duration-300 shadow-md hover:shadow-lg transform hover:scale-105">
                                +1 å°ç« 
                            </button>
            
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stamp Card -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-8 mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">é›†é»å¡</h2>
            
            <!-- Stamps Grid -->
            <div class="grid grid-cols-10 gap-3 mb-8" id="stampsGrid">
                <!-- Stamps will be generated by JavaScript -->
            </div>
            
            <!-- Quick Actions -->
            <div class="flex justify-between items-center">
                <button onclick="confirmResetCurrentLesson()" class="bg-gradient-to-r from-orange-300 to-red-300 hover:from-orange-400 hover:to-red-400 text-white px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                    é‡ç½®æœ¬å ‚èª²
                </button>
                <button onclick="confirmUpload()" class="bg-gradient-to-r from-blue-300 to-cyan-300 hover:from-blue-400 hover:to-cyan-400 text-white px-8 py-4 rounded-xl font-bold text-lg transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                    ä¸Šå‚³æœ¬é€±èª²ç¨‹å°ç« 
                </button>
            </div>
        </div>

        <!-- Gifts Section -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">æ¨‚ç†ç­ç¦®ç‰©åˆ—è¡¨</h2>
            <div class="text-center mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div>
                            <span class="text-lg font-semibold text-gray-700">ç›®å‰ç« æ•¸ï¼š</span>
                            <span class="text-lg font-bold text-blue-400" id="currentProgress">0 / 80</span>
                        </div>
                        <div>
                            <span class="text-lg font-semibold text-gray-700">ä¸Šå­¸æœŸå‰©é¤˜ï¼š</span>
                            <span class="text-lg font-bold text-cyan-600" id="previousPointsDisplay">0 é»</span>
                        </div>
                        <div>
                            <span class="text-lg font-semibold text-gray-700">ç¸½è¨ˆï¼š</span>
                            <span class="text-lg font-bold text-indigo-600" id="totalPointsDisplay">0 é»</span>
                        </div>
                    </div>
                    <button onclick="showGiftSelectionModal()" class="bg-slate-300 hover:bg-slate-400 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                        æ±ºå®šç¦®ç‰©
                    </button>
                </div>
            </div>
            
        
         
            <!-- 30 Points -->
            <div class="bg-slate-50 rounded-lg p-4 mb-4 border border-slate-200">
                <h3 class="text-lg font-semibold text-slate-700 mb-3 flex items-center">
                    <span class="bg-slate-300 text-white px-2 py-1 rounded-full text-sm mr-2">30é»</span>
                    æ–‡å…·
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(30, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> è‡ªå‹•é‰›ç­†
                    </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(30, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> å°º
                    </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(30, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> é‰›ç­†
                    </label>
                  <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(30, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> åŸå­ç­†
                    </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(30, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> ç«‹å¯å¸¶
                       </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(30, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> ç­†è¨˜æœ¬
                       </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(30, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> æ©¡çš®æ“¦
                    </label>
                </div>
            </div>

            <!-- 40 Points -->
            <div class="bg-slate-50 rounded-lg p-4 mb-4 border border-slate-200">
                <h3 class="text-lg font-semibold text-slate-700 mb-3 flex items-center">
                    <span class="bg-slate-300 text-white px-2 py-1 rounded-full text-sm mr-2">40é»</span>
                    æ–‡å…·
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(40, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> è³‡æ–™å¤¾
                    </label>
                </div>
            </div>

            <!-- 65 Points -->
            <div class="bg-slate-50 rounded-lg p-4 mb-4 border border-slate-200">
                <h3 class="text-lg font-semibold text-slate-700 mb-3 flex items-center">
                    <span class="bg-slate-300 text-white px-2 py-1 rounded-full text-sm mr-2">65é»</span>
                    ç‰¹è‰²å•†å“
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(65, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> å¯¶å¯å¤¢çƒåŠé£¾
                    </label>
                </div>
            </div>

            <!-- 75 Points -->
            <div class="bg-slate-50 rounded-lg p-4 mb-4 border border-slate-200">
                <h3 class="text-lg font-semibold text-slate-700 mb-3 flex items-center">
                    <span class="bg-slate-300 text-white px-2 py-1 rounded-full text-sm mr-2">75é»</span>
                    ç²¾ç¾æ–‡å…·å’Œå°ç©å¶
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(75, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> å¡çš®å·´æ‹‰åŠé£¾
                    </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(75, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> é›¶éŒ¢åŒ…
                    </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(75, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> å¯¶å¯å¤¢è³‡æ–™å¤¾
                    </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(75, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> å‰ä¼Šå¡å“‡åŠé£¾
                    </label>
                    <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(75, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> ç™¾è®Šæ€ª10å…¬åˆ†ç©å¶
                     <label class="flex items-center text-gray-700 cursor-pointer" onclick="checkGiftRequirement(75, this)">
                        <input type="checkbox" class="mr-2" onclick="event.stopPropagation()"> å¯é”é´¨10å…¬åˆ†ç©å¶
                    </label>
                </div>
            </div>

    </div>

    <!-- Reward Modal -->
    <div id="rewardModal" class="reward-modal" style="display: none;">
        <div class="reward-card">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">æ­å–œç²å¾—çå‹µï¼</h3>
            <p class="text-gray-600 mb-4" id="rewardText"></p>
            <button onclick="closeRewardModal()" class="bg-slate-300 hover:bg-slate-400 text-white px-6 py-2 rounded-lg font-semibold">
                å¤ªæ£’äº†ï¼
            </button>
        </div>
    </div>


    <!-- Password Modal -->
    <div id="passwordModal" class="export-modal" style="display: none;" onclick="closePasswordModal()">
        <div class="export-card" onclick="event.stopPropagation()">
            <div class="text-4xl mb-4">ğŸ”’</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">è¼¸å…¥å¯†ç¢¼</h3>
            <p class="text-gray-600 mb-4">è«‹è¼¸å…¥å¯†ç¢¼ä»¥ä¿®æ”¹ä¸Šå­¸æœŸå‰©é¤˜é»æ•¸</p>
            <div class="mb-4">
                <input type="password" id="passwordInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-center" 
                       placeholder="è«‹è¼¸å…¥å¯†ç¢¼" maxlength="4">
            </div>
            <div class="flex space-x-4 justify-center">
                <button onclick="verifyPassword()" class="bg-slate-300 hover:bg-slate-400 text-white px-6 py-2 rounded-lg font-semibold">
                    ç¢ºèª
                </button>
                <button onclick="closePasswordModal()" class="bg-slate-200 hover:bg-slate-300 text-white px-4 py-2 rounded-lg">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Points Modal -->
    <div id="editPointsModal" class="export-modal" style="display: none;">
        <div class="export-card">
            <div class="text-4xl mb-4">âœï¸</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ä¿®æ”¹ä¸Šå­¸æœŸå‰©é¤˜é»æ•¸</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">é»æ•¸</label>
                <input type="number" id="editPointsInput" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-center" 
                       min="0" max="999" value="0">
            </div>
            <div class="flex space-x-4 justify-center">
                <button onclick="savePreviousPoints()" class="bg-slate-300 hover:bg-slate-400 text-white px-6 py-2 rounded-lg font-semibold">
                    å„²å­˜
                </button>
                <button onclick="closeEditPointsModal()" class="bg-slate-200 hover:bg-slate-300 text-white px-4 py-2 rounded-lg">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Gift Selection Modal -->
    <div id="giftSelectionModal" class="export-modal" style="display: none;" onclick="closeGiftSelectionModal()">
        <div class="export-card max-w-4xl max-h-96 overflow-y-auto" onclick="event.stopPropagation()">
            <div class="text-4xl mb-4">ğŸ</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">æ±ºå®šç¦®ç‰©</h3>
            <p class="text-gray-600 mb-4">æ ¹æ“šç›®å‰é»æ•¸é¸æ“‡æƒ³è¦çš„ç¦®ç‰©ï¼ˆå¯è¤‡é¸ï¼‰</p>
            
            <div id="giftOptions" class="space-y-4 mb-6">
                <!-- Gift options will be populated by JavaScript -->
            </div>
            
            <div class="border-t pt-4">
                <h4 class="font-semibold text-gray-800 mb-2">å·²é¸æ“‡çš„ç¦®ç‰©ï¼š</h4>
                <div id="selectedGifts" class="text-gray-600 min-h-6">å°šæœªé¸æ“‡ä»»ä½•ç¦®ç‰©</div>
            </div>
            
            <div class="flex space-x-4 justify-center mt-6">
                <button onclick="saveGiftSelection()" class="bg-slate-300 hover:bg-slate-400 text-white px-6 py-2 rounded-lg font-semibold">
                    å„²å­˜é¸æ“‡
                </button>
                <button onclick="closeGiftSelectionModal()" class="bg-slate-200 hover:bg-slate-300 text-white px-4 py-2 rounded-lg">
                    å–æ¶ˆ
                </button>
            </div>
        </div>
    </div>

    

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDwfcITcACP3VCkaM2ylHImj38JfikUB6k",
            authDomain: "student-punch-card.firebaseapp.com",
            projectId: "student-punch-card",
            storageBucket: "student-punch-card.firebasestorage.app",
            messagingSenderId: "1234567890",
            appId: "1:1234567890:web:152e6a859c4ede36184dc5",
            measurementId: "G-3V1P3EM2G8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase functions available globally
        window.db = db;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.onSnapshot = onSnapshot;
    </script>

    <script>
        // ğŸ”¥ å®Œå…¨ç¨ç«‹çš„å­¸ç”Ÿè³‡æ–™ç®¡ç†ç³»çµ±
        let currentStudentData = {
            studentName: '',
            stamps: [],
            startDate: '',
            currentLessonStamps: 0,
            previousPoints: 0,
            selectedGifts: []
        };

        // å­¸ç”Ÿè³‡æ–™åº« - æ¯å€‹å­¸ç”Ÿå®Œå…¨ç¨ç«‹
        const StudentDataManager = {
            // å„²å­˜å­¸ç”Ÿè³‡æ–™åˆ°æœ¬åœ°
            saveStudentData: function(studentName, data) {
                const key = `STUDENT_DATA_${studentName}`;
                const studentData = {
                    studentName: studentName,
                    stamps: [...data.stamps],
                    startDate: data.startDate,
                    currentLessonStamps: data.currentLessonStamps,
                    previousPoints: data.previousPoints,
                    selectedGifts: [...data.selectedGifts],
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(key, JSON.stringify(studentData));
                console.log(`âœ… ${studentName} çš„è³‡æ–™å·²å„²å­˜åˆ°æœ¬åœ°`);
            },

            // å¾æœ¬åœ°è¼‰å…¥å­¸ç”Ÿè³‡æ–™
            loadStudentData: function(studentName) {
                const key = `STUDENT_DATA_${studentName}`;
                const savedData = localStorage.getItem(key);
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    console.log(`ğŸ“‚ è¼‰å…¥ ${studentName} çš„æœ¬åœ°è³‡æ–™:`, data);
                    return data;
                } else {
                    // å»ºç«‹æ–°å­¸ç”Ÿçš„ç©ºç™½è³‡æ–™
                    const newData = {
                        studentName: studentName,
                        stamps: [],
                        startDate: new Date().toLocaleDateString('zh-TW'),
                        currentLessonStamps: 0,
                        previousPoints: 0,
                        selectedGifts: []
                    };
                    this.saveStudentData(studentName, newData);
                    console.log(`ğŸ†• ç‚º ${studentName} å»ºç«‹æ–°çš„è³‡æ–™`);
                    return newData;
                }
            },

            // åˆ‡æ›å­¸ç”Ÿ
            switchStudent: function(studentName) {
                if (!studentName) {
                    currentStudentData = {
                        studentName: '',
                        stamps: [],
                        startDate: '',
                        currentLessonStamps: 0,
                        previousPoints: 0,
                        selectedGifts: []
                    };
                    return;
                }

                // è¼‰å…¥å­¸ç”Ÿè³‡æ–™
                const data = this.loadStudentData(studentName);
                currentStudentData = {
                    studentName: data.studentName,
                    stamps: [...data.stamps],
                    startDate: data.startDate,
                    currentLessonStamps: data.currentLessonStamps,
                    previousPoints: data.previousPoints,
                    selectedGifts: [...data.selectedGifts]
                };

                console.log(`ğŸ”„ å·²åˆ‡æ›åˆ° ${studentName}:`, currentStudentData);
            }
        };

        // Firebase functions - å®Œå…¨ç¨ç«‹çš„å­¸ç”Ÿè³‡æ–™å„²å­˜
        async function saveToFirebase() {
            if (!currentStudentData.studentName) {
                console.log('æ²’æœ‰é¸æ“‡å­¸ç”Ÿï¼Œè·³éFirebaseå„²å­˜');
                return;
            }
            
            try {
                const studentDoc = window.doc(window.db, 'independent_students', currentStudentData.studentName);
                
                const studentData = {
                    studentName: currentStudentData.studentName,
                    stamps: [...currentStudentData.stamps],
                    startDate: currentStudentData.startDate,
                    currentLessonStamps: currentStudentData.currentLessonStamps,
                    previousPoints: currentStudentData.previousPoints,
                    selectedGifts: [...currentStudentData.selectedGifts],
                    lastUpdated: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };
                
                await window.setDoc(studentDoc, studentData, { merge: false });
                console.log(`âœ… ${currentStudentData.studentName} çš„ç¨ç«‹è³‡æ–™å·²å„²å­˜åˆ°Firebase`);
            } catch (error) {
                console.error('âŒ Firebaseå„²å­˜å¤±æ•—:', error);
                showFeedback('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
            }
        }

        async function loadFromFirebase() {
            if (!currentStudentData.studentName) {
                console.log('æ²’æœ‰é¸æ“‡å­¸ç”Ÿï¼Œè·³éFirebaseè¼‰å…¥');
                return;
            }
            
            try {
                const studentDoc = window.doc(window.db, 'independent_students', currentStudentData.studentName);
                const docSnap = await window.getDoc(studentDoc);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log(`ğŸ”„ é–‹å§‹è¼‰å…¥ ${currentStudentData.studentName} çš„é›²ç«¯è³‡æ–™...`);
                    
                    // æ›´æ–°ç•¶å‰å­¸ç”Ÿè³‡æ–™
                    currentStudentData = {
                        studentName: data.studentName,
                        stamps: [...data.stamps],
                        startDate: data.startDate,
                        currentLessonStamps: data.currentLessonStamps,
                        previousPoints: data.previousPoints,
                        selectedGifts: [...data.selectedGifts]
                    };
                    
                    // åŒæ™‚æ›´æ–°æœ¬åœ°å„²å­˜
                    StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
                    
                    // æ›´æ–°UI
                    updateUI();
                    
                    console.log(`âœ… ${currentStudentData.studentName} çš„é›²ç«¯è³‡æ–™è¼‰å…¥å®Œæˆ`);
                } else {
                    console.log(`ğŸ“ ${currentStudentData.studentName} åœ¨é›²ç«¯æ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™`);
                }
            } catch (error) {
                console.error('âŒ Firebaseè¼‰å…¥å¤±æ•—:', error);
                console.log('ğŸ”„ æ”¹ç”¨æœ¬åœ°è³‡æ–™');
            }
        }

        function updateUI() {
            // æ›´æ–°æ‰€æœ‰UIå…ƒç´ 
            document.getElementById('previousPoints').value = currentStudentData.previousPoints;
            document.getElementById('startDate').textContent = currentStudentData.startDate;
            generateStamps();
            updateProgressDisplay();
            updateGiftDisplay();
            updateGiftAvailability();
        }

        // ç§»é™¤å­¸ç”Ÿåˆ‡æ›è¦–çª—åŠŸèƒ½ï¼Œæ”¹ç‚ºç›´æ¥åˆ‡æ›

        function initializeCard() {
            // ç›´æ¥è¼‰å…¥å›ºå®šå­¸ç”Ÿï¼šç‹æ™Ÿå‡±
            const fixedStudentName = 'ç‹æ™Ÿå‡±';
            StudentDataManager.switchStudent(fixedStudentName);
            updateUI();
        }

        async function loadStudentData() {
            const studentNameInput = document.getElementById('studentName');
            const newStudentName = studentNameInput.value.trim();
            
            if (!newStudentName) {
                alert('è«‹è¼¸å…¥å­¸ç”Ÿå§“åï¼');
                return;
            }
            
            if (newStudentName === currentStudentData.studentName) {
                showFeedback('å·²ç¶“æ˜¯ç•¶å‰å­¸ç”Ÿï¼');
                return;
            }
            
            console.log(`ğŸ”„ é–‹å§‹è¼‰å…¥å­¸ç”Ÿ: ${newStudentName}`);
            
            // é¡¯ç¤ºè¼‰å…¥è¦–çª—
            showLoadingOverlay();
            
            try {
                // å…ˆå„²å­˜ç•¶å‰å­¸ç”Ÿè³‡æ–™
                if (currentStudentData.studentName) {
                    StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
                    try {
                        await saveToFirebase();
                    } catch (error) {
                        console.log('ç•¶å‰å­¸ç”Ÿè³‡æ–™Firebaseå„²å­˜å¤±æ•—');
                    }
                }
                
                // åˆ‡æ›å­¸ç”Ÿ
                StudentDataManager.switchStudent(newStudentName);
                localStorage.setItem('lastSelectedStudent', newStudentName);
                
                // ç«‹å³æ›´æ–°UI
                updateUI();
                
                // å˜—è©¦å¾Firebaseè¼‰å…¥
                await loadFromFirebase();
                
                // æˆåŠŸå¾Œ3ç§’é—œé–‰è¼‰å…¥è¦–çª—
                setTimeout(() => {
                    hideLoadingOverlay('success');
                }, 3000);
                
                console.log(`âœ… æˆåŠŸè¼‰å…¥ ${newStudentName}`);
            } catch (error) {
                console.error('è¼‰å…¥å­¸ç”Ÿå¤±æ•—:', error);
                // å¤±æ•—å¾Œ3ç§’é—œé–‰è¼‰å…¥è¦–çª—ä¸¦é¡¯ç¤ºå¤±æ•—
                setTimeout(() => {
                    hideLoadingOverlay('failed');
                }, 3000);
            }
        }

        function updateProgressDisplay() {
            const currentStamps = currentStudentData.stamps.length;
            const previousPoints = currentStudentData.previousPoints;
            const totalPoints = currentStamps + previousPoints;
            
            const progressElement = document.getElementById('currentProgress');
            const previousPointsElement = document.getElementById('previousPointsDisplay');
            const totalPointsElement = document.getElementById('totalPointsDisplay');
            
            if (progressElement) {
                progressElement.textContent = `${currentStamps} / 80`;
            }
            if (previousPointsElement) {
                previousPointsElement.textContent = `${previousPoints} é»`;
            }
            if (totalPointsElement) {
                totalPointsElement.textContent = `${totalPoints} é»`;
            }
        }

        function updateGiftDisplay() {
            if (!currentStudentData.studentName) return;
            
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            
            // Clear all checkboxes first
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Check the selected gifts for this student
            currentStudentData.selectedGifts.forEach(giftName => {
                checkboxes.forEach(checkbox => {
                    const label = checkbox.closest('label');
                    if (label && label.textContent.trim() === giftName) {
                        checkbox.checked = true;
                    }
                });
            });
        }

        function generateStamps() {
            const stampsGrid = document.getElementById('stampsGrid');
            if (!stampsGrid) return;
            
            stampsGrid.innerHTML = '';
            
            for (let i = 0; i < 80; i++) {
                const stampDiv = document.createElement('div');
                stampDiv.className = 'stamp-circle';
                stampDiv.setAttribute('data-index', i);
                stampDiv.onclick = () => toggleStamp(i);
                
                if (currentStudentData.stamps.includes(i)) {
                    stampDiv.classList.add('stamped');
                    stampDiv.innerHTML = 'âœ“';
                } else {
                    stampDiv.innerHTML = (i + 1).toString();
                }
                
                stampsGrid.appendChild(stampDiv);
            }
            
            updateProgressDisplay();
        }

        async function toggleStamp(index) {
            if (!currentStudentData.studentName) {
                showStudentSelectionAlert();
                return;
            }
            
            const nextStampIndex = currentStudentData.stamps.length;
            
            if (currentStudentData.stamps.includes(index)) {
                if (index === Math.max(...currentStudentData.stamps)) {
                    currentStudentData.stamps = currentStudentData.stamps.filter(s => s !== index);
                } else {
                    alert('åªèƒ½ç§»é™¤æœ€å¾Œä¸€å€‹å°ç« ï¼');
                    return;
                }
            } else {
                if (index === nextStampIndex) {
                    currentStudentData.stamps.push(index);
                    currentStudentData.stamps.sort((a, b) => a - b);
                } else {
                    alert('è«‹æŒ‰ç…§é †åºé›†é»ï¼');
                    return;
                }
            }
            
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            generateStamps();
            await saveToFirebase();
        }

        async function addStampsByRule(count) {
            if (!currentStudentData.studentName) {
                showStudentSelectionAlert();
                return;
            }

            if (currentStudentData.currentLessonStamps + count > 5) {
                alert(`æœ¬å ‚èª²å·²ç´¯ç© ${currentStudentData.currentLessonStamps} å€‹å°ç« ï¼Œæœ€å¤šåªèƒ½ç´¯ç© 5 å€‹å°ç« ï¼`);
                return;
            }
            
            for (let i = 0; i < count; i++) {
                for (let j = 0; j < 80; j++) {
                    if (!currentStudentData.stamps.includes(j)) {
                        currentStudentData.stamps.push(j);
                        currentStudentData.stamps.sort((a, b) => a - b);
                        currentStudentData.currentLessonStamps++;
                        break;
                    }
                }
            }
            
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            generateStamps();
            await saveToFirebase();
            
            showFeedback(`å·²æ–°å¢ ${count} å€‹å°ç« ï¼æœ¬å ‚èª²ç´¯ç©ï¼š${currentStudentData.currentLessonStamps}/5`);
        }

        async function confirmUpload() {
            if (!currentStudentData.studentName) {
                alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼');
                return;
            }
            
            await saveToFirebase();
            currentStudentData.currentLessonStamps = 0;
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            
            showFeedback('å·²ä¸Šå‚³å°ç« è‡³é›²ç«¯ï¼Œç‚ºæ‚¨æº–å‚™ä¸‹ä¸€å ‚èª²ã€‚');
        }

        function confirmResetCurrentLesson() {
            if (!currentStudentData.studentName) {
                alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼');
                return;
            }
            
            if (currentStudentData.currentLessonStamps === 0) {
                alert('æœ¬å ‚èª²å°šæœªæ–°å¢ä»»ä½•å°ç« ï¼');
                return;
            }
            
            showResetConfirmModal();
        }

        async function resetCurrentLesson() {
            for (let i = 0; i < currentStudentData.currentLessonStamps; i++) {
                if (currentStudentData.stamps.length > 0) {
                    currentStudentData.stamps.pop();
                }
            }
            
            currentStudentData.currentLessonStamps = 0;
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            generateStamps();
            await saveToFirebase();
            showFeedback('å·²é‡ç½®æœ¬å ‚èª²çš„å°ç« ï¼');
        }

        function showResetConfirmModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex justify-center items-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md mx-4 text-center">
                    <div class="text-4xl mb-4" style="color: red;">â•</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ç¢ºèªé‡ç½®æœ¬å ‚èª²</h3>
                    <p class="text-gray-600 mb-6">ç¢ºå®šè¦é‡ç½®æœ¬å ‚èª²çš„ ${currentStudentData.currentLessonStamps} å€‹å°ç« å—ï¼Ÿ</p>
                    <div class="flex space-x-4 justify-center">
                        <button onclick="confirmReset()" class="bg-red-200 hover:bg-red-300 text-red-800 px-6 py-2 rounded-lg font-semibold">
                            ç¢ºå®šé‡ç½®
                        </button>
                        <button onclick="cancelReset()" class="bg-slate-200 hover:bg-slate-300 text-white px-6 py-2 rounded-lg font-semibold">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentResetModal = modal;
        }

        async function confirmReset() {
            await resetCurrentLesson();
            document.body.removeChild(window.currentResetModal);
        }

        function cancelReset() {
            document.body.removeChild(window.currentResetModal);
        }

        function showStudentSelectionAlert() {
            const modal = document.createElement('div');
            modal.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex justify-center items-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md mx-4 text-center">
                    <div class="text-4xl mb-4">ğŸ‘©ğŸ¼â€ğŸ“ğŸ‘¨ğŸ¼â€ğŸ“</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">è«‹é¸æ“‡å­¸ç”Ÿ</h3>
                    <p class="text-gray-600 mb-6">è«‹å…ˆåœ¨ä¸Šæ–¹é¸æ“‡å­¸ç”Ÿï¼Œæ‰èƒ½é–‹å§‹é›†é»ï¼</p>
                    <button onclick="closeStudentAlert()" class="bg-slate-300 hover:bg-slate-400 text-white px-6 py-2 rounded-lg font-semibold">
                        æˆ‘çŸ¥é“äº†
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentStudentAlert = modal;
        }

        function closeStudentAlert() {
            if (window.currentStudentAlert) {
                document.body.removeChild(window.currentStudentAlert);
            }
        }

        // Password and previous points functions
        function showPasswordModal() {
            // ç›´æ¥é¡¯ç¤ºç·¨è¼¯é»æ•¸è¦–çª—ï¼Œä¸éœ€è¦å¯†ç¢¼é©—è­‰
            showEditPointsModal();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function verifyPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === '0103') {
                closePasswordModal();
                showEditPointsModal();
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼');
                document.getElementById('passwordInput').value = '';
            }
        }

        function showEditPointsModal() {
            document.getElementById('editPointsInput').value = currentStudentData.previousPoints;
            document.getElementById('editPointsModal').style.display = 'flex';
            document.getElementById('editPointsInput').focus();
        }

        function closeEditPointsModal() {
            document.getElementById('editPointsModal').style.display = 'none';
        }

        async function savePreviousPoints() {
            const points = parseInt(document.getElementById('editPointsInput').value) || 0;
            currentStudentData.previousPoints = points;
            document.getElementById('previousPoints').value = points;
            
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            
            try {
                await saveToFirebase();
                showFeedback(`å·²æ›´æ–°ä¸Šå­¸æœŸå‰©é¤˜é»æ•¸ï¼š${points} é»`);
            } catch (error) {
                showFeedback('é»æ•¸å·²å„²å­˜åˆ°æœ¬åœ°ï¼Œä½†é›²ç«¯åŒæ­¥å¤±æ•—', 'warning');
            }
            
            closeEditPointsModal();
            updateProgressDisplay();
            updateGiftAvailability();
        }

        function checkGiftRequirement(requiredPoints, labelElement) {
            const currentStamps = currentStudentData.stamps.length;
            const totalPoints = currentStamps + currentStudentData.previousPoints;
            const checkbox = labelElement.querySelector('input[type="checkbox"]');
            
            if (totalPoints >= requiredPoints) {
                checkbox.checked = !checkbox.checked;
            } else {
                if (!checkbox.checked) {
                    const pointsNeeded = requiredPoints - totalPoints;
                    showPointsNeededAlert(pointsNeeded);
                }
            }
        }

        function showPointsNeededAlert(pointsNeeded) {
            const modal = document.createElement('div');
            modal.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex justify-center items-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl p-6 max-w-md mx-4 text-center">
                    <div class="text-4xl mb-4">ğŸ’ª</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ç¹¼çºŒåŠªåŠ›ï¼</h3>
                    <p class="text-gray-600 mb-6">é‚„å·® ${pointsNeeded} é»å°±å¯ä»¥å…Œæ›é€™å€‹ç¦®ç‰©äº†ï¼</p>
                    <button onclick="closePointsAlert()" class="bg-slate-300 hover:bg-slate-400 text-white px-6 py-2 rounded-lg font-semibold">
                        æˆ‘æœƒåŠ æ²¹çš„ï¼
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentPointsAlert = modal;
        }

        function closePointsAlert() {
            if (window.currentPointsAlert) {
                document.body.removeChild(window.currentPointsAlert);
            }
        }

        function showAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'flex';
            document.getElementById('newStudentName').value = '';
            document.getElementById('newStudentName').focus();
        }

        function closeAddStudentModal() {
            document.getElementById('addStudentModal').style.display = 'none';
        }



        // Gift selection functionality
        const giftCategories = [
    {
        title: "æ–‡å…·",
        points: 30,
        color: "slate",
        gifts: ["è‡ªå‹•é‰›ç­†", "å°º", "é‰›ç­†", "åŸå­ç­†", "ç«‹å¯å¸¶", "ç­†è¨˜æœ¬", "æ©¡çš®æ“¦"]
    },
    {
        title: "æ–‡å…·",
        points: 40,
        color: "slate",
        gifts: ["è³‡æ–™å¤¾"]
    },
    {
        title: "ç‰¹è‰²å•†å“",
        points: 65,
        color: "slate",
        gifts: ["å¯¶å¯å¤¢çƒåŠé£¾"]
    },
    {
        title: "ç²¾ç¾æ–‡å…·å’Œå°ç©å…·",
        points: 75,
        color: "slate",
        gifts: ["å¡çš®å·´æ‹‰åŠé£¾", "é›¶éŒ¢åŒ…", "å¯¶å¯å¤¢è³‡æ–™å¤¾", "ä¼Šå¸ƒå¡åš•åŠé£¾", "ç™¾è®Šæ€ª10å…¬åˆ†ç©å…·", "å¯é”é´¨10å…¬åˆ†ç©å…·"]
    }
];
        function showGiftSelectionModal() {

            const currentStamps = currentStudentData.stamps.length;
            const totalPoints = currentStamps + currentStudentData.previousPoints;
            const giftOptionsContainer = document.getElementById('giftOptions');
            giftOptionsContainer.innerHTML = '';

            giftCategories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = `bg-slate-50 border border-slate-200 rounded-lg p-4`;
                categoryDiv.innerHTML = `
                    <h4 class="text-lg font-semibold text-slate-700 mb-3 flex items-center">
                        <span class="bg-slate-300 text-white px-2 py-1 rounded-full text-sm mr-2">${category.points}é»</span>
                        ${category.title}
                        ${totalPoints < category.points ? '<span class="text-red-500 text-sm ml-2">(é»æ•¸ä¸è¶³)</span>' : ''}
                    </h4>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        ${category.gifts.map(gift => `
                            <label class="flex items-center text-gray-700 cursor-pointer ${totalPoints < category.points ? 'opacity-50' : ''}">
                                <input type="checkbox" class="mr-2 gift-checkbox" data-gift="${gift}" data-points="${category.points}" 
                                       ${totalPoints < category.points ? 'disabled' : ''} onchange="updateSelectedGifts()"> 
                                ${gift}
                            </label>
                        `).join('')}
                    </div>
                `;
                giftOptionsContainer.appendChild(categoryDiv);
            });

            loadSelectedGifts();
            updateSelectedGifts();
            
            document.getElementById('giftSelectionModal').style.display = 'flex';
        }

        function loadSelectedGifts() {
            const checkboxes = document.querySelectorAll('.gift-checkbox');
            
            checkboxes.forEach(checkbox => {
                if (currentStudentData.selectedGifts.includes(checkbox.dataset.gift)) {
                    checkbox.checked = true;
                }
            });
        }

        function updateSelectedGifts() {
            const selectedCheckboxes = document.querySelectorAll('.gift-checkbox:checked');
            const selectedGiftsDiv = document.getElementById('selectedGifts');
            
            if (selectedCheckboxes.length === 0) {
                selectedGiftsDiv.textContent = 'å°šæœªé¸æ“‡ä»»ä½•ç¦®ç‰©';
                selectedGiftsDiv.className = 'text-gray-600 min-h-6';
            } else {
                const gifts = Array.from(selectedCheckboxes).map(cb => cb.dataset.gift);
                selectedGiftsDiv.innerHTML = gifts.map(gift => 
                    `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm mr-2 mb-1">${gift}</span>`
                ).join('');
                selectedGiftsDiv.className = 'min-h-6';
            }
        }

        async function saveGiftSelection() {
            const selectedCheckboxes = document.querySelectorAll('.gift-checkbox:checked');
            const selectedGifts = Array.from(selectedCheckboxes).map(cb => cb.dataset.gift);
            
            currentStudentData.selectedGifts = [...selectedGifts];
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            
            try {
                await saveToFirebase();
                showFeedback(`å·²ç‚º ${currentStudentData.studentName} è¨˜éŒ„ç¦®ç‰©é¸æ“‡ï¼`);
            } catch (error) {
                showFeedback('ç¦®ç‰©é¸æ“‡å·²å„²å­˜åˆ°æœ¬åœ°ï¼Œä½†é›²ç«¯åŒæ­¥å¤±æ•—', 'warning');
            }
            
            closeGiftSelectionModal();
        }

        function closeGiftSelectionModal() {
            document.getElementById('giftSelectionModal').style.display = 'none';
        }

        function showRewardModal(reward) {
            document.getElementById('rewardText').textContent = `ä½ å·²ç¶“${reward.description}ï¼ç²å¾—ã€Œ${reward.title}ã€çå‹µï¼`;
            document.getElementById('rewardModal').style.display = 'flex';
        }

        function closeRewardModal() {
            document.getElementById('rewardModal').style.display = 'none';
        }
function updateGiftAvailability() {
    const currentStamps = currentStudentData.stamps.length;
    const totalPoints = currentStamps + currentStudentData.previousPoints;
    
    // æ›´æ–°æ‰€æœ‰ç¦®ç‰©é …ç›®çš„å¯é¸ç‹€æ…‹
    const giftLabels = document.querySelectorAll('label[onclick*="checkGiftRequirement"]');
    
    giftLabels.forEach(label => {
        const onclickAttr = label.getAttribute('onclick');
        // å¾ onclick å±¬æ€§ä¸­æå–éœ€è¦çš„é»æ•¸
        const match = onclickAttr.match(/checkGiftRequirement\((\d+),/);
        if (match) {
            const requiredPoints = parseInt(match[1]);
            const checkbox = label.querySelector('input[type="checkbox"]');
            
            if (totalPoints >= requiredPoints) {
                // æœ‰è¶³å¤ é»æ•¸ - å•Ÿç”¨
                label.classList.remove('opacity-50');
                label.style.cursor = 'pointer';
                if (checkbox && !currentStudentData.selectedGifts.includes(label.textContent.trim())) {
                    checkbox.disabled = false;
                }
            } else {
                // é»æ•¸ä¸è¶³ - åœç”¨
                label.classList.add('opacity-50');
                label.style.cursor = 'not-allowed';
                if (checkbox && !checkbox.checked) {
                    checkbox.disabled = true;
                }
            }
        }
    });
}
        function showFeedback(message, type = 'success') {
            const feedback = document.createElement('div');
            let bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';
            
            feedback.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all`;
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(feedback)) {
                        document.body.removeChild(feedback);
                    }
                }, 300);
            }, 3000);
        }

        // Loading overlay functions
        function showLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = overlay.querySelector('p');
            loadingText.textContent = 'æ­£åœ¨è¼‰å…¥å°ˆå±¬è³‡æ–™...';
            loadingText.className = 'text-gray-600';
            overlay.style.display = 'flex';
        }

        function hideLoadingOverlay(status) {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = overlay.querySelector('p');
            const spinner = overlay.querySelector('.loading-spinner');
            
            if (status === 'success') {
                spinner.style.display = 'none';
                loadingText.textContent = 'è¼‰å…¥æˆåŠŸï¼';
                loadingText.className = 'text-green-600 font-semibold';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    spinner.style.display = 'block'; // é‡ç½®spinneré¡¯ç¤º
                }, 1000);
            } else if (status === 'failed') {
                spinner.style.display = 'none';
                loadingText.textContent = 'è¼‰å…¥å¤±æ•—';
                loadingText.className = 'text-red-600 font-semibold';
                
                setTimeout(() => {
                    overlay.style.display = 'none';
                    spinner.style.display = 'block'; // é‡ç½®spinneré¡¯ç¤º
                }, 2000);
            }
        }

        // Make all functions globally available
        window.addStampsByRule = addStampsByRule;
        window.confirmResetCurrentLesson = confirmResetCurrentLesson;
        window.confirmUpload = confirmUpload;
        window.closeRewardModal = closeRewardModal;
        window.showPasswordModal = showPasswordModal;
        window.closePasswordModal = closePasswordModal;
        window.verifyPassword = verifyPassword;
        window.showEditPointsModal = showEditPointsModal;
        window.closeEditPointsModal = closeEditPointsModal;
        window.savePreviousPoints = savePreviousPoints;
        window.checkGiftRequirement = checkGiftRequirement;
        window.closePointsAlert = closePointsAlert;
        window.loadStudentData = loadStudentData;
        window.showGiftSelectionModal = showGiftSelectionModal;
        window.closeGiftSelectionModal = closeGiftSelectionModal;
        window.saveGiftSelection = saveGiftSelection;
        window.updateSelectedGifts = updateSelectedGifts;
        window.confirmReset = confirmReset;
        window.cancelReset = cancelReset;
        window.closeStudentAlert = closeStudentAlert;
        window.showLoadingOverlay = showLoadingOverlay;
        window.hideLoadingOverlay = hideLoadingOverlay;

        // Initialize the card when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–ç‹æ™Ÿå‡±çš„é›†é»å¡...');
            
            // ç«‹å³é¡¯ç¤º80å€‹åœ“åœˆ
            generateStamps();
            updateProgressDisplay();
            
            // åˆå§‹åŒ–å›ºå®šå­¸ç”Ÿ
            initializeCard();
            
            // å˜—è©¦å¾Firebaseè¼‰å…¥å­¸ç”Ÿçš„è³‡æ–™
            setTimeout(async () => {
                await loadFromFirebase();
            }, 500);
        });
    </script>
    <script>
const correctPassword = "0103"; // æ­£ç¢ºå¯†ç¢¼

// æ‰“é–‹å¯†ç¢¼å½ˆçª—
function showPasswordModal() {
    document.getElementById("passwordModal").style.display = "flex";
}

// é—œé–‰å¯†ç¢¼å½ˆçª—
function closePasswordModal() {
    document.getElementById("passwordModal").style.display = "none";
}
}
</script>

  <script>
    // ===== ä½ çš„ JavaScript Code é–‹å§‹ =====
    async function toggleStamp(index) {
        if (!currentStudentData.studentName) {
            showStudentSelectionAlert();
            return;
        }
        
        const nextStampIndex = currentStudentData.stamps.length;
        
        if (currentStudentData.stamps.includes(index)) {
            if (index === Math.max(...currentStudentData.stamps)) {
                currentStudentData.stamps = currentStudentData.stamps.filter(s => s !== index);
            } else {
                alert('åªèƒ½ç§»é™¤æœ€å¾Œä¸€å€‹è“‹ç« ï¼');
                return;
            }
        } else {
            if (index === nextStampIndex) {
                currentStudentData.stamps.push(index);
                currentStudentData.stamps.sort((a, b) => a - b);
            } else {
                alert('è«‹æŒ‰ç…§é †åºé›†é»ï¼');
                return;
            }
        }
        
        StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
        generateStamps();
        saveToFirebase().catch(error => {
            console.error('Firebaseå„²å­˜å¤±æ•—ï¼Œä½†æœ¬åœ°å·²å„²å­˜:', error);
        });
    }

    async function addStampsByRule(count) {
        if (!currentStudentData.studentName) {
            showStudentSelectionAlert();
            return;
        }

        if (currentStudentData.currentLessonStamps + count > 4) {
            alert(`æœ¬å ‚èª²å·²ç´¯ç© ${currentStudentData.currentLessonStamps} å€‹è“‹ç« ï¼Œæœ€å¤šåªèƒ½ç´¯ç© 4 å€‹è“‹ç« ï¼`);
            return;
        }
        
        for (let i = 0; i < count; i++) {
            for (let j = 0; j < 80; j++) {
                if (!currentStudentData.stamps.includes(j)) {
                    currentStudentData.stamps.push(j);
                    currentStudentData.stamps.sort((a, b) => a - b);
                    currentStudentData.currentLessonStamps++;
                    break;
                }
            }
        }
        
        StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
        generateStamps();
        saveToFirebase().catch(error => {
            console.error('Firebaseå„²å­˜å¤±æ•—ï¼Œä½†æœ¬åœ°å·²å„²å­˜:', error);
        });
        
        showFeedback(`å·²æ–°å¢ ${count} å€‹è“‹ç« ï¼æœ¬å ‚èª²ç´¯ç©ï¼š${currentStudentData.currentLessonStamps}/4`);
    }

    function generateStamps() {
        const stampsGrid = document.getElementById('stampsGrid');
        if (!stampsGrid) return;
        
        stampsGrid.innerHTML = '';
        
        for (let i = 0; i < 80; i++) {
            const stampDiv = document.createElement('div');
            stampDiv.className = 'stamp-circle';
            stampDiv.setAttribute('data-index', i);
            stampDiv.onclick = () => toggleStamp(i);
            
            if (currentStudentData.stamps.includes(i)) {
                stampDiv.classList.add('stamped');
                stampDiv.innerHTML = 'âœ“';
            } else {
                stampDiv.innerHTML = (i + 1).toString();
            }
            
            stampsGrid.appendChild(stampDiv);
        }
        
        updateProgressDisplay();
        
        if (currentStudentData.studentName) {
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
        }
    }

    document.addEventListener('DOMContentLoaded', async function() {
        console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–ç‹æ™Ÿå‡±çš„é›†é»å¡...');
        generateStamps();
        updateProgressDisplay();
        initializeCard();
        
        updateGiftAvailability();
        
        setTimeout(async () => {
            try {
                await loadFromFirebase();
                console.log('âœ… Firebaseè³‡æ–™è¼‰å…¥å®Œæˆ');
            } catch (error) {
                console.log('ğŸ“‚ ä½¿ç”¨æœ¬åœ°è³‡æ–™ï¼ŒFirebaseè¼‰å…¥å¤±æ•—:', error);
            }
        }, 1000);
    });

    window.addEventListener('beforeunload', function() {
        if (currentStudentData.studentName) {
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            if (window.db) {
                saveToFirebase().catch(() => {});
            }
        }
    });

    setInterval(() => {
        if (currentStudentData.studentName && currentStudentData.stamps.length > 0) {
            StudentDataManager.saveStudentData(currentStudentData.studentName, currentStudentData);
            saveToFirebase().catch(error => {
                console.log('å®šæœŸå„²å­˜ï¼šFirebaseåŒæ­¥å¤±æ•—ï¼Œä½†æœ¬åœ°å·²å„²å­˜');
            });
        }
    }, 30000);
    // ===== ä½ çš„ JavaScript Code çµæŸ =====
  </script>
<script>
async function uploadCurrentData() {
    if (!currentStudentData.studentName) {
        alert('è«‹å…ˆé¸æ“‡å­¸ç”Ÿï¼');
        return;
    }
    
    try {
        await saveToFirebase();
        showFeedback(`${currentStudentData.studentName}çš„è³‡æ–™å·²ä¸Šå‚³åˆ°é›²ç«¯ï¼`);
    } catch (error) {
        showFeedback('ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
        console.error('Firebaseä¸Šå‚³éŒ¯èª¤:', error);
    }
}

// å°‡å‡½æ•¸åŠ å…¥å…¨åŸŸå¯ç”¨
window.uploadCurrentData = uploadCurrentData;
</script>


<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e2aa81a32b6c01',t:'MTc1NzcxNDMwNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>